<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MatchDay Navigator • World Cup 2026 (Resilient single-file)</title>

  <style>
    /* ====== Dark base theme ====== */
    :root { --bg:#0b0e12; --text:#dfe7f3; --muted:#a7b6cc; --line:#1c2430; --brand:#1e90ff; --hover:#111823; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { background: var(--bg); color: var(--text); font: 14px/1.4 system-ui, Arial, sans-serif; }

    header.top {
      display:flex; align-items:center; justify-content:space-between;
      height:56px; padding:8px 14px; border-bottom:1px solid var(--line); background:#0d1117;
      position:sticky; top:0; z-index:5;
    }
    header .brand { font-weight:700; color:#eaf2ff; }

    /* Map + simple sidebar */
    main.layout { display:grid; grid-template-columns: 1fr 320px; height: calc(100vh - 56px); }
    #map { width:100%; height:100%; background:#000; }

    aside.panel { border-left:1px solid var(--line); background:#0f1319; overflow:auto; padding:10px; }
    aside h2 { margin:6px 0 8px; font-size:12px; color:#88a9ff; text-transform:uppercase; letter-spacing:.06em; }
    .item { padding:6px 8px; border-radius:6px; cursor:pointer; margin:2px 0; }
    .item:hover { background:var(--hover); }
    .line { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .city { color:#cfe5ff; font-weight:600; }
    .country { color:#b8c6dd; }
    .stadium { color:#ffd970; }
    small.sep { color:#3a475b; }

    /* Mobile: bottom tray */
    @media (max-width: 900px) {
      main.layout { grid-template-columns: 1fr; }
      #map { height: 55vh; }
      aside.panel {
        height: 45vh; position:fixed; inset:auto 0 0 0; border-left:0; border-top:1px solid var(--line);
      }
    }

    /* ====== CRITICAL Leaflet layout rules (subset, prevents patchy tiles) ====== */
    .leaflet-container { overflow: hidden; outline: 0; }
    .leaflet-pane,
    .leaflet-tile,
    .leaflet-marker-icon,
    .leaflet-marker-shadow,
    .leaflet-tile-container,
    .leaflet-pane > svg,
    .leaflet-pane > canvas,
    .leaflet-zoom-box,
    .leaflet-image-layer,
    .leaflet-layer { position: absolute; left: 0; top: 0; }
    .leaflet-pane { z-index: 400; }
    .leaflet-map-pane    { z-index: 200; }
    .leaflet-tile-pane   { z-index: 200; }
    .leaflet-overlay-pane{ z-index: 400; }
    .leaflet-marker-pane { z-index: 600; }
    .leaflet-tooltip-pane{ z-index: 650; }
    .leaflet-popup-pane  { z-index: 700; }
    .leaflet-tile { width:256px; height:256px; user-select:none; -webkit-user-drag:none; }
    .leaflet-container img { max-width: none !important; }
    .leaflet-zoom-animated { transform-origin: 0 0; }
    .leaflet-zoom-anim .leaflet-zoom-animated { transition: none !important; }
    .leaflet-tile-container { pointer-events: none; }
    .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-image-layer, .leaflet-pane > svg path { pointer-events:auto; }

    /* Dark UI for controls & popups */
    .leaflet-control-zoom a { background:#0f141c; color:#cfe5ff; border:1px solid #1a2230; }
    .leaflet-popup-content-wrapper { background:#0f141c; color:#eaf2ff; border:1px solid #1a2230; }
    .leaflet-popup-tip { background:#0f141c; }
    .leaflet-tooltip { background:#0f141c; color:#cfe5ff; border:1px solid #1a2230; }

    /* Tiny overlay to surface fatal errors (so we don’t guess) */
    #err { position: fixed; right: 10px; bottom: 10px; max-width: 48ch; padding: 8px 10px;
           background: #311; color: #ffdada; border: 1px solid #633; border-radius: 6px; font-size: 12px; display:none; z-index:9999; }
  </style>
</head>
<body>
  <header class="top">
    <div class="brand">MatchDay Navigator</div>
  </header>

  <main class="layout">
    <section id="map" aria-label="World Cup 2026 Map"></section>
    <aside class="panel">
      <h2>Cities</h2>
      <div id="cityList"></div>
    </aside>
  </main>

  <div id="err"></div>

  <script>
    /* ---------- small helpers ---------- */
    function showErr(msg){
      var box = document.getElementById('err');
      box.textContent = msg;
      box.style.display = 'block';
      console.error('[MDN]', msg);
    }
    function addScript(src, ok, fail){
      var s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = ok; s.onerror = function(){ fail && fail(src); };
      document.head.appendChild(s);
    }

    /* ---------- dataset ---------- */
    var CITIES = [
      { slug:'new-york-new-jersey', name:'New York / New Jersey', country:'USA',    lat:40.813528, lng:-74.074361 },
      { slug:'dallas',              name:'Dallas (Arlington)',    country:'USA',    lat:32.747780, lng:-97.092780 },
      { slug:'houston',             name:'Houston',               country:'USA',    lat:29.684720, lng:-95.410830 },
      { slug:'kansas-city',         name:'Kansas City',           country:'USA',    lat:39.048890, lng:-94.483890 },
      { slug:'atlanta',             name:'Atlanta',               country:'USA',    lat:33.755560, lng:-84.400000 },
      { slug:'los-angeles',         name:'Los Angeles (Inglewood)',country:'USA',  lat:33.953000, lng:-118.339000 },
      { slug:'toronto',             name:'Toronto',               country:'Canada', lat:43.633330, lng:-79.418610 },
      { slug:'vancouver',           name:'Vancouver',             country:'Canada', lat:49.276684, lng:-123.112404 },
      { slug:'mexico-city',         name:'Mexico City',           country:'Mexico', lat:19.303060, lng:-99.150560 },
      { slug:'guadalajara',         name:'Guadalajara',           country:'Mexico', lat:20.681670, lng:-103.462780 },
      { slug:'monterrey',           name:'Monterrey',             country:'Mexico', lat:25.669170, lng:-100.244440 }
    ];
    var STADIUMS = [
      { slug:'metlife-stadium',       name:'MetLife Stadium',       citySlug:'new-york-new-jersey' },
      { slug:'att-stadium',           name:'AT&T Stadium',          citySlug:'dallas' },
      { slug:'nrg-stadium',           name:'NRG Stadium',           citySlug:'houston' },
      { slug:'arrowhead-stadium',     name:'Arrowhead Stadium',     citySlug:'kansas-city' },
      { slug:'mercedes-benz-stadium', name:'Mercedes-Benz Stadium', citySlug:'atlanta' },
      { slug:'sofi-stadium',          name:'SoFi Stadium',          citySlug:'los-angeles' },
      { slug:'bmo-field',             name:'BMO Field',             citySlug:'toronto' },
      { slug:'bc-place',              name:'BC Place',              citySlug:'vancouver' },
      { slug:'estadio-azteca',        name:'Estadio Azteca',        citySlug:'mexico-city' },
      { slug:'estadio-bbva',          name:'Estadio BBVA',          citySlug:'monterrey' },
      { slug:'estadio-akron',         name:'Estadio Akron',         citySlug:'guadalajara' }
    ];

    /* ---------- boot once Leaflet is loaded ---------- */
    function boot(){
      if (!window.L) { showErr('Leaflet failed to load'); return; }

      // Map (no animations on first paint)
      var map = L.map('map', { zoomControl:true, worldCopyJump:true, zoomAnimation:false, fadeAnimation:false });

      // Try Carto Dark Matter, fall back to OSM if tile errors occur
      var cartoUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
      var osmUrl   = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

      var base = L.tileLayer(cartoUrl, {
        attribution: '© OpenStreetMap contributors © CARTO',
        subdomains: 'abcd', maxZoom: 20
      }).addTo(map);

      var switched = false;
      base.on('tileerror', function(){
        if (!switched) {
          switched = true;
          map.removeLayer(base);
          L.tileLayer(osmUrl, {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
          }).addTo(map);
          showErr('Carto tiles unavailable, switched to OpenStreetMap.');
        }
      });

      // Icons
      function svgPin(fill, stroke){
        stroke = stroke || '#0a3d62';
        var svg = "<svg xmlns='http://www.w3.org/2000/svg' width='25' height='41' viewBox='0 0 25 41'>"
                + "<path d='M12.5 0C5.6 0 0 5.6 0 12.5c0 9.2 10.6 17.2 11.2 17.7a2 2 0 0 0 2.6 0C14.4 29.7 25 21.7 25 12.5 25 5.6 19.4 0 12.5 0z' fill='" + fill + "' stroke='" + stroke + "' stroke-width='1'/>"
                + "<circle cx='12.5' cy='12.5' r='5' fill='#fff'/></svg>";
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      }
      var ICON_CITY = L.icon({ iconUrl: svgPin('#1e90ff'), iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[0,-36] });

      // Stadium lookup
      var stadiumByCitySlug = {};
      for (var i=0;i<STADIUMS.length;i++){ var s=STADIUMS[i]; if (!stadiumByCitySlug[s.citySlug]) stadiumByCitySlug[s.citySlug] = s.name; }

      // Markers
      var cityMarkers = {}, all = [];
      for (var j=0;j<CITIES.length;j++){
        var c = CITIES[j];
        var popup = "<b>" + c.name + "</b><br/>" + c.country;
        if (stadiumByCitySlug[c.slug]) popup += "<br/><small>" + stadiumByCitySlug[c.slug] + "</small>";
        var m = L.marker([c.lat, c.lng], { icon: ICON_CITY }).bindPopup(popup).bindTooltip(c.name);
        m.addTo(map);
        cityMarkers[c.slug] = m; all.push(m);
      }
      if (all.length){ var fg = L.featureGroup(all); map.fitBounds(fg.getBounds(), { padding:[40,40] }); }
      else { map.setView([37.8,-96],4); }

      // Sidebar
      var listEl = document.getElementById('cityList');
      function render(items){
        listEl.innerHTML='';
        for (var k=0;k<items.length;k++){
          var c = items[k], st = stadiumByCitySlug[c.slug] || '';
          var el = document.createElement('div'); el.className='item';
          el.innerHTML = "<div class='line'><span class='city'>" + c.name + "</span>"
                       + "<small class='sep'>—</small><span class='country'>" + c.country + "</span>"
                       + (st ? "<small class='sep'>·</small><span class='stadium'>" + st + "</span>" : "")
                       + "</div>";
          (function(slug){
            el.addEventListener('click', function(){
              var m = cityMarkers[slug]; if (!m) return;
              map.flyTo(m.getLatLng(), 6, { duration: 0.8 });
              setTimeout(function(){ m.openPopup(); }, 850);
            });
          })(c.slug);
          listEl.appendChild(el);
        }
      }
      render(CITIES);

      // Finalize layout
      window.addEventListener('load', function(){ map.invalidateSize(); });
      base.on('load', function(){ map.invalidateSize(); });
      requestAnimationFrame(function(){ map.invalidateSize(); });
      window.addEventListener('resize', function(){ map.invalidateSize(); });
    }

    /* ---------- Load Leaflet JS with 2‑CDN fallback ---------- */
    addScript(
      'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
      function(){ boot(); },
      function(){ addScript(
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
        function(){ boot(); },
        function(){ showErr('Leaflet JS could not be loaded from CDN.'); }
      );}
    );
  </script>
</body>
</html>