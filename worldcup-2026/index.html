<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MatchDay Navigator • World Cup 2026 (Accurate Labels + Hover Copy)</title>

<style>
  /* ===== Theme tokens ===== */
  :root{
    --bg:#0b0e12; --panel:#0f1319; --text:#dfe7f3; --muted:#a7b6cc; --line:#1c2430;
    --brand:#1e90ff; --hover:#111823; --gold:#f7d354; --accent:#88a9ff;
    --label-bg:rgba(0,0,0,.55); --label-city:#cfe5ff; --label-stadium:#ffd970;
  }
  :root[data-theme="light"]{
    --bg:#f7f9fc; --panel:#ffffff; --text:#1b2430; --muted:#5b6a82; --line:#d8e0ea;
    --brand:#0d6efd; --hover:#eef3fb; --gold:#bc8a00; --accent:#0d6efd;
    --label-bg:rgba(255,255,255,.9); --label-city:#223a63; --label-stadium:#8b6b00;
  }

  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0 }
  body{ background:var(--bg); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Arial }

  /* Header + tools */
  header.top{
    display:flex; align-items:center; justify-content:space-between;
    height:56px; padding:8px 14px; border-bottom:1px solid var(--line); background:var(--panel);
    position:sticky; top:0; z-index:5;
  }
  .brand{ font-weight:700; color:var(--text) }
  .tools{ display:flex; gap:10px; align-items:center }
  #search{
    background:transparent; color:var(--text); border:1px solid var(--line);
    padding:6px 8px; border-radius:6px; min-width:240px
  }
  .filters label{ color:var(--muted); margin-left:8px; font-size:12px }
  .theme-toggle{
    background:transparent; color:var(--text); border:1px solid var(--line);
    padding:6px 10px; border-radius:6px; cursor:pointer
  }

  /* Layout */
  main.layout{ display:grid; grid-template-columns: 1fr 360px; height:calc(100vh - 56px) }
  #map{ width:100%; height:100%; background:#000 }

  aside.panel{
    border-left:1px solid var(--line); background:var(--panel);
    overflow:hidden; padding:10px; display:flex; flex-direction:column
  }
  .tabs{ display:flex; gap:8px; margin-bottom:6px }
  .tabs button{
    background:transparent; color:var(--text); border:1px solid var(--line);
    padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:600
  }
  .tabs button.active{ background:var(--hover); border-color:var(--accent); color:var(--text) }
  h2{ margin:6px 0 8px; font-size:12px; color:var(--accent); text-transform:uppercase; letter-spacing:.06em }

  /* Lists (column packed) */
  .list{ flex:1 1 auto; overflow:hidden }
  .colpack{ column-gap:12px }
  .item{ break-inside:avoid; padding:4px 6px; margin:2px 0; border-radius:6px; cursor:pointer; display:flex }
  .item:hover{ background:var(--hover) }
  .line{ display:flex; gap:6px; align-items:baseline; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px; line-height:1.25; flex:1 }
  .city{ color:var(--text); font-weight:700 }
  .country{ color:var(--muted) }
  .stadium{ color:var(--gold); font-weight:600 }
  .stadium.link{ text-decoration:underline; cursor:pointer }
  .actions{ display:flex; gap:6px; margin-left:8px; opacity:0; visibility:hidden; transition:opacity .15s ease }
  .item:hover .actions{ opacity:1; visibility:visible }
  .btn{ font-size:11px; color:var(--text); background:transparent; border:1px solid var(--line); padding:2px 6px; border-radius:5px; cursor:pointer }
  .btn:hover{ background:var(--hover) }

  /* Map tooltips (labels) — small & themed */
  .label-city, .label-stadium{
    background:var(--label-bg) !important; color:var(--label-city);
    border:1px solid var(--line); border-radius:4px; padding:1px 4px; font-size:11px; line-height:1.15;
  }
  .label-stadium{ color:var(--label-stadium) }
  .leaflet-tooltip-top:before{ border-top-color:var(--label-bg) !important } /* arrow color */

  /* Mobile */
  @media (max-width:900px){
    main.layout{ grid-template-columns:1fr }
    #map{ height:55vh }
    aside.panel{ height:45vh; position:fixed; inset:auto 0 0 0; border-left:0; border-top:1px solid var(--line); overflow:auto }
    .colpack{ column-count:1 !important }
  }

  /* Leaflet critical layout (prevents patchy tiles) */
  .leaflet-container{ overflow:hidden; outline:0 }
  .leaflet-pane,.leaflet-tile,.leaflet-marker-icon,.leaflet-marker-shadow,
  .leaflet-tile-container,.leaflet-pane>svg,.leaflet-pane>canvas,
  .leaflet-zoom-box,.leaflet-image-layer,.leaflet-layer{ position:absolute; left:0; top:0 }
  .leaflet-map-pane,.leaflet-tile-pane{ z-index:200 } .leaflet-pane{ z-index:400 }
  .leaflet-overlay-pane{ z-index:400 } .leaflet-marker-pane{ z-index:600 }
  .leaflet-tooltip-pane{ z-index:650 } .leaflet-popup-pane{ z-index:700 }
  .leaflet-tile{ width:256px; height:256px; user-select:none; -webkit-user-drag:none }
  .leaflet-container img{ max-width:none !important }
  .leaflet-zoom-animated{ transform-origin:0 0 }
  .leaflet-zoom-anim .leaflet-zoom-animated{ transition:none !important }
  .leaflet-tile-container{ pointer-events:none }
  .leaflet-marker-icon,.leaflet-marker-shadow,.leaflet-image-layer,.leaflet-pane>svg path{ pointer-events:auto }

  /* Controls & popups */
  .leaflet-control-zoom a{ background:var(--panel); color:var(--text); border:1px solid var(--line) }
  .leaflet-popup-content-wrapper{ background:var(--panel); color:var(--text); border:1px solid var(--line) }
  .leaflet-popup-tip{ background:var(--panel) }
  .leaflet-tooltip{ background:var(--panel); color:var(--text); border:1px solid var(--line) }

  /* Error / toast */
  #err{ position:fixed; right:10px; bottom:10px; max-width:48ch; padding:8px 10px;
        background:#311; color:#ffdada; border:1px solid #633; border-radius:6px; font-size:12px; display:none; z-index:9999 }
  #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:var(--panel); color:var(--text);
          border:1px solid var(--line); padding:6px 10px; border-radius:6px; font-size:12px; display:none; z-index:9999 }
</style>
</head>
<body>
  <header class="top">
    <div class="brand">MatchDay Navigator</div>
    <div class="tools">
      <input id="search" type="text" placeholder="Search city or stadium…" />
      <span class="filters">
        <label><input type="checkbox" id="fUSA" checked> USA</label>
        <label><input type="checkbox" id="fCAN" checked> Canada</label>
        <label><input type="checkbox" id="fMEX" checked> Mexico</label>
      </span>
      <button id="themeBtn" class="theme-toggle" title="Toggle dark / light">Dark</button>
    </div>
  </header>

  <main class="layout">
    <section id="map" aria-label="World Cup 2026 Map"></section>
    <aside class="panel">
      <nav class="tabs">
        <button id="tabCities" class="active" data-tab="cities">Cities</button>
        <button id="tabStadiums" data-tab="stadiums">Stadiums</button>
      </nav>

      <div id="citiesPane" class="list" role="region" aria-label="Cities list">
        <h2>Cities</h2>
        <div id="cityList" class="colpack"></div>
      </div>

      <div id="stadiumsPane" class="list" role="region" aria-label="Stadiums list" style="display:none">
        <h2>Stadiums</h2>
        <div id="stadiumList" class="colpack"></div>
      </div>
    </aside>
  </main>

  <div id="err"></div>
  <div id="toast">Link copied</div>

  <script>
    /* ===== helpers ===== */
    const $ = sel => document.querySelector(sel);
    function showErr(msg){ const b=$("#err"); b.textContent=msg; b.style.display='block'; console.error('[MDN]',msg); }
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1200); }
    function addScript(src, ok, fail){ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=ok; s.onerror=()=>fail&&fail(src); document.head.appendChild(s); }
    function setQuery(k, v){ const url=new URL(location.href); if(v==null){url.searchParams.delete(k);} else {url.searchParams.set(k,v);} history.pushState({},"",url); }
    const getQ = name => new URLSearchParams(location.search).get(name);

    /* ===== data ===== */
    const CITIES = [
      { slug:'new-york-new-jersey', name:'New York / New Jersey', country:'USA',    lat:40.813528, lng:-74.074361 },
      { slug:'dallas',              name:'Dallas (Arlington)',    country:'USA',    lat:32.747780, lng:-97.092780 },
      { slug:'houston',             name:'Houston',               country:'USA',    lat:29.684720, lng:-95.410830 },
      { slug:'kansas-city',         name:'Kansas City',           country:'USA',    lat:39.048890, lng:-94.483890 },
      { slug:'atlanta',             name:'Atlanta',               country:'USA',    lat:33.755560, lng:-84.400000 },
      { slug:'los-angeles',         name:'Los Angeles (Inglewood)',country:'USA',  lat:33.953000, lng:-118.339000 },
      { slug:'toronto',             name:'Toronto',               country:'Canada', lat:43.633330, lng:-79.418610 },
      { slug:'vancouver',           name:'Vancouver',             country:'Canada', lat:49.276684, lng:-123.112404 },
      { slug:'mexico-city',         name:'Mexico City',           country:'Mexico', lat:19.303060, lng:-99.150560 },
      { slug:'guadalajara',         name:'Guadalajara',           country:'Mexico', lat:20.681670, lng:-103.462780 },
      { slug:'monterrey',           name:'Monterrey',             country:'Mexico', lat:25.669170, lng:-100.244440 }
    ];
    const STADIUMS = [
      { slug:'metlife-stadium',       name:'MetLife Stadium',       citySlug:'new-york-new-jersey', lat:40.813528, lng:-74.074361 },
      { slug:'att-stadium',           name:'AT&T Stadium',          citySlug:'dallas',              lat:32.747780, lng:-97.092780 },
      { slug:'nrg-stadium',           name:'NRG Stadium',           citySlug:'houston',             lat:29.684720, lng:-95.410830 },
      { slug:'arrowhead-stadium',     name:'Arrowhead Stadium',     citySlug:'kansas-city',         lat:39.048890, lng:-94.483890 },
      { slug:'mercedes-benz-stadium', name:'Mercedes-Benz Stadium', citySlug:'atlanta',             lat:33.755560, lng:-84.400000 },
      { slug:'sofi-stadium',          name:'SoFi Stadium',          citySlug:'los-angeles',         lat:33.953000, lng:-118.339000 },
      { slug:'bmo-field',             name:'BMO Field',             citySlug:'toronto',             lat:43.633330, lng:-79.418610 },
      { slug:'bc-place',              name:'BC Place',              citySlug:'vancouver',           lat:49.276684, lng:-123.112404 },
      { slug:'estadio-azteca',        name:'Estadio Azteca',        citySlug:'mexico-city',         lat:19.303060, lng:-99.150560 },
      { slug:'estadio-bbva',          name:'Estadio BBVA',          citySlug:'monterrey',           lat:25.669170, lng:-100.244440 },
      { slug:'estadio-akron',         name:'Estadio Akron',         citySlug:'guadalajara',         lat:20.681670, lng:-103.462780 }
    ];

    /* ===== boot (after Leaflet + Cluster) ===== */
    function boot(){
      if(!window.L){ showErr('Leaflet failed to load'); return; }

      /* theme */
      const themeBtn = $("#themeBtn");
      const savedTheme = localStorage.getItem('mdn-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      themeBtn.textContent = savedTheme==='dark' ? 'Dark' : 'Light';

      /* map + tiles */
      const map = L.map('map',{ zoomControl:true, worldCopyJump:true, zoomAnimation:false, fadeAnimation:false });
      map.attributionControl.setPrefix(''); // hide “Leaflet” link, keep providers

      const LAYERS = {
        dark:  { url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',  attr:'© OpenStreetMap contributors © CARTO', max:20 },
        light: { url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', attr:'© OpenStreetMap contributors © CARTO', max:20 }
      };
      const OSM = { url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr:'© OpenStreetMap contributors', max:19 };

      let activeTile;
      function setTiles(mode){
        if(activeTile) map.removeLayer(activeTile);
        const cfg = (mode==='light') ? LAYERS.light : LAYERS.dark;
        let switched=false;
        activeTile = L.tileLayer(cfg.url,{ attribution:cfg.attr, subdomains:'abcd', maxZoom:cfg.max })
          .on('tileerror',()=>{ if(!switched){ switched=true; map.removeLayer(activeTile); activeTile=L.tileLayer(OSM.url,{attribution:OSM.attr,maxZoom:OSM.max}).addTo(map); showErr('Primary tiles unavailable, switched to OSM.'); }})
          .addTo(map);
      }
      setTiles(savedTheme);
      themeBtn.addEventListener('click', ()=>{
        const next = (document.documentElement.getAttribute('data-theme')==='dark') ? 'light':'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('mdn-theme', next);
        themeBtn.textContent = next==='dark' ? 'Dark' : 'Light';
        setTiles(next);
      });

      /* icons */
      function svgPin(fill, stroke){ stroke=stroke||'#0a3d62';
        const svg="<svg xmlns='http://www.w3.org/2000/svg' width='25' height='41' viewBox='0 0 25 41'>"
                +"<defs><filter id='g'><feDropShadow dx='0' dy='0' stdDeviation='2' flood-color='"+fill+"' flood-opacity='0.85'/></filter></defs>"
                +"<path filter='url(#g)' d='M12.5 0C5.6 0 0 5.6 0 12.5c0 9.2 10.6 17.2 11.2 17.7a2 2 0 0 0 2.6 0C14.4 29.7 25 21.7 25 12.5 25 5.6 19.4 0 12.5 0z' fill='"+fill+"' stroke='"+stroke+"' stroke-width='1'/>"
                +"<circle cx='12.5' cy='12.5' r='5' fill='#fff'/></svg>";
        return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
      }
      function svgPinActive(fill){
        const svg="<svg xmlns='http://www.w3.org/2000/svg' width='30' height='50' viewBox='0 0 25 41'>"
                +"<defs><filter id='ag'><feDropShadow dx='0' dy='0' stdDeviation='3' flood-color='"+fill+"' flood-opacity='0.95'/></filter></defs>"
                +"<path filter='url(#ag)' d='M12.5 0C5.6 0 0 5.6 0 12.5c0 9.2 10.6 17.2 11.2 17.7a2 2 0 0 0 2.6 0C14.4 29.7 25 21.7 25 12.5 25 5.6 19.4 0 12.5 0z' fill='"+fill+"' stroke='#07243a' stroke-width='1'/>"
                +"<circle cx='12.5' cy='12.5' r='5' fill='#fff'/></svg>";
        return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
      }
      const ICONS = {
        city:          L.icon({ iconUrl: svgPin('#1e90ff'),       iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[0,-36] }),
        stadium:       L.icon({ iconUrl: svgPin('#f7d354'),       iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[0,-36] }),
        cityActive:    L.icon({ iconUrl: svgPinActive('#1e90ff'), iconSize:[30,50], iconAnchor:[15,50], popupAnchor:[0,-44] }),
        stadiumActive: L.icon({ iconUrl: svgPinActive('#f7d354'), iconSize:[30,50], iconAnchor:[15,50], popupAnchor:[0,-44] })
      };

      /* clusters (tuned to reduce “2” bubbles) */
      function neonCluster(size){
        const s=Math.max(30, 22+(size.toString().length*6)+Math.min(40,size));
        return L.divIcon({ html:
          "<div style=\"display:flex;align-items:center;justify-content:center;width:"+s+"px;height:"+s+"px;border-radius:50%;"
          +"background:radial-gradient(ellipse at center, rgba(30,144,255,.95) 0%, rgba(30,144,255,.65) 60%, rgba(30,144,255,.25) 100%);"
          +"box-shadow:0 0 14px rgba(30,144,255,.6);color:#fff;font-weight:700;\">"+size+"</div>",
          className:'', iconSize:[s,s] });
      }
      function clusterIconCreate(cluster){ return neonCluster(cluster.getChildCount()); }
      const cityCluster = (window.L.MarkerClusterGroup)
        ? new L.MarkerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:40, disableClusteringAtZoom:6, spiderfyOnMaxZoom:true, iconCreateFunction:clusterIconCreate })
        : null;
      const stadiumCluster = (window.L.MarkerClusterGroup)
        ? new L.MarkerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:35, disableClusteringAtZoom:6, spiderfyOnMaxZoom:true, iconCreateFunction:clusterIconCreate })
        : null;
      if(cityCluster) cityCluster.on('clusterclick', e => e.layer.spiderfy());
      if(stadiumCluster) stadiumCluster.on('clusterclick', e => e.layer.spiderfy());

      /* active marker state */
      let active = { type:null, slug:null, marker:null };
      function clearActive(){ if(!active.marker) return;
        active.marker.setIcon(active.type==='city'? ICONS.city : ICONS.stadium);
        active={ type:null, slug:null, marker:null };
      }
      function setActive(type, slug){
        clearActive();
        const m = (type==='city')? cityMarkersBySlug[slug] : stadiumMarkersBySlug[slug];
        if(!m) return;
        m.setIcon(type==='city'? ICONS.cityActive : ICONS.stadiumActive);
        if(m.bringToFront) m.bringToFront();
        active={ type, slug, marker:m };
      }

      /* markers + tooltips (labels bound to marker) */
      const cityMarkersBySlug={}, stadiumMarkersBySlug={};
      function bindLabelIf(m, text, className){
        // (Re)bind a small permanent tooltip to a marker
        m.bindTooltip(text, { permanent:true, direction:'top', offset:[0,-12], className:className, opacity:1, interactive:false });
      }
      function unbindLabel(m){ if(m && m.getTooltip()) m.unbindTooltip(); }

      /* visibility helpers */
      function visibleUnclustered(m){
        // If using clusters, a marker is visibly unclustered only when getVisibleParent(m) === m
        if(cityCluster && cityCluster.hasLayer(m)){
          const vp = cityCluster.getVisibleParent ? cityCluster.getVisibleParent(m) : null;
          return vp ? (vp === m) : !!m._icon;
        }
        if(stadiumCluster && stadiumCluster.hasLayer(m)){
          const vp = stadiumCluster.getVisibleParent ? stadiumCluster.getVisibleParent(m) : null;
          return vp ? (vp === m) : !!m._icon;
        }
        return !!m._icon; // non-clustered: rendered if it has an _icon
      }

      function syncLabels(){
        const b = map.getBounds();
        Object.entries(cityMarkersBySlug).forEach(([slug, m])=>{
          const should = visibleUnclustered(m) && b.contains(m.getLatLng());
          const has = !!m.getTooltip();
          if(should && !has) bindLabelIf(m, CITIES.find(c=>c.slug===slug).name, 'label-city');
          if(!should && has) unbindLabel(m);
        });
        Object.entries(stadiumMarkersBySlug).forEach(([slug, m])=>{
          const should = visibleUnclustered(m) && b.contains(m.getLatLng());
          const has = !!m.getTooltip();
          if(should && !has) bindLabelIf(m, STADIUMS.find(s=>s.slug===slug).name, 'label-stadium');
          if(!should && has) unbindLabel(m);
        });
      }

      /* build markers */
      CITIES.forEach(c=>{
        const m = L.marker([c.lat,c.lng],{icon:ICONS.city})
          .bindPopup("<b>"+c.name+"</b><br/>"+c.country)
          .on('popupopen', ()=> setActive('city', c.slug));
        cityMarkersBySlug[c.slug]=m;
        if(cityCluster) cityCluster.addLayer(m); else m.addTo(map);
      });
      STADIUMS.forEach(s=>{
        const m = L.marker([s.lat,s.lng],{icon:ICONS.stadium})
          .bindPopup("<b>"+s.name+"</b>")
          .on('popupopen', ()=> setActive('stadium', s.slug));
        stadiumMarkersBySlug[s.slug]=m;
        if(stadiumCluster) stadiumCluster.addLayer(m); else m.addTo(map);
      });
      if(cityCluster) map.addLayer(cityCluster);
      if(stadiumCluster) map.addLayer(stadiumCluster);

      /* reveal without zoom */
      function revealMarker(m, type){
        if(!m) return;
        const parent = m.__parent;
        if(parent && parent.spiderfy && parent._zoom === map.getZoom()){
          try{ parent.spiderfy(); }catch(e){}
        }
        const sidebarWidth=360;
        map.panInside(m.getLatLng(), { animate:true, paddingTopLeft:[20,20], paddingBottomRight:[sidebarWidth+20,20] });
        if(type){
          const slug = (type==='city')
            ? Object.keys(cityMarkersBySlug).find(k=>cityMarkersBySlug[k]===m)
            : Object.keys(stadiumMarkersBySlug).find(k=>stadiumMarkersBySlug[k]===m);
          if(slug) setActive(type, slug);
        }
        setTimeout(()=>m.openPopup(), 250);
      }

      /* fit & label sync */
      const allMarkers = Object.values(cityMarkersBySlug).concat(Object.values(stadiumMarkersBySlug));
      function fitAll(){
        if(allMarkers.length){
          const fg=L.featureGroup(allMarkers);
          map.fitBounds(fg.getBounds(),{padding:[40,40]});
        } else map.setView([37.8,-96],4);
      }
      map.on('zoomend moveend layeradd layerremove animationend', syncLabels);
      if(cityCluster) cityCluster.on('spiderfied unspiderfied', syncLabels);
      if(stadiumCluster) stadiumCluster.on('spiderfied unspiderfied', syncLabels);

      /* ----- Sidebar (tabs + hover copy) ----- */
      const listCities = $("#cityList"), listStads=$("#stadiumList");
      const tabCities=$("#tabCities"), tabStadiums=$("#tabStadiums");
      const paneCities=$("#citiesPane"), paneStads=$("#stadiumsPane");

      function packIntoColumns(container){
        if (window.matchMedia('(max-width: 900px)').matches){ container.style.columnCount=1; return; }
        const panel=container.closest('.list'); const h=panel.clientHeight - 50;
        const sample=container.querySelector('.item'); const rowH=sample?Math.max(18,sample.getBoundingClientRect().height):18;
        const rows=container.children.length||1; const needed=Math.ceil((rows*rowH)/Math.max(1,h));
        container.style.columnCount=Math.min(Math.max(needed,1),4);
      }
      function setTab(which){
        if(which==='cities'){
          tabCities.classList.add('active'); tabStadiums.classList.remove('active');
          paneCities.style.display='block';   paneStads.style.display='none';
          packIntoColumns(listCities);
        }else{
          tabStadiums.classList.add('active'); tabCities.classList.remove('active');
          paneStads.style.display='block';     paneCities.style.display='none';
          packIntoColumns(listStads);
        }
      }
      tabCities.addEventListener('click', ()=> setTab('cities'));
      tabStadiums.addEventListener('click', ()=> setTab('stadiums'));

      function cityDeepLink(slug){ const u=new URL(location.href); u.searchParams.set('city',slug); u.searchParams.delete('stadium'); return u.toString(); }
      function stadDeepLink(slug){ const u=new URL(location.href); u.searchParams.set('stadium',slug); u.searchParams.delete('city'); return u.toString(); }

      function renderCityList(items){
        listCities.innerHTML='';
        items.forEach(c=>{
          const el=document.createElement('div'); el.className='item';
          const line=document.createElement('div'); line.className='line';
          const spanCity=document.createElement('span'); spanCity.className='city'; spanCity.textContent=c.name;
          const sep1=document.createElement('small'); sep1.className='sep'; sep1.textContent='—';
          const spanCountry=document.createElement('span'); spanCountry.className='country'; spanCountry.textContent=c.country;
          const actions=document.createElement('span'); actions.className='actions';
          const btn=document.createElement('button'); btn.className='btn btn-copy'; btn.textContent='Copy link';
          btn.addEventListener('click', ev=>{ ev.stopPropagation(); navigator.clipboard.writeText(cityDeepLink(c.slug)).then(()=>toast('City link copied')); });
          actions.appendChild(btn);
          line.append(spanCity, sep1, spanCountry);
          el.append(line, actions);

          el.addEventListener('click',()=>{
            setQuery('city', c.slug); setQuery('stadium', null);
            const m=cityMarkersBySlug[c.slug]; revealMarker(m,'city'); syncLabels();
          });
          listCities.appendChild(el);
        });
        packIntoColumns(listCities);
      }

      function renderStadiumList(items){
        listStads.innerHTML='';
        items.forEach(s=>{
          const city=CITIES.find(c=>c.slug===s.citySlug)||{ name:'', country:'' };
          const el=document.createElement('div'); el.className='item';
          const line=document.createElement('div'); line.className='line';
          const spanSt=document.createElement('span'); spanSt.className='stadium'; spanSt.textContent=s.name;
          const sep1=document.createElement('small'); sep1.className='sep'; sep1.textContent='—';
          const spanCity=document.createElement('span'); spanCity.className='city'; spanCity.textContent=city.name;
          const sep2=document.createElement('small'); sep2.className='sep'; sep2.textContent='·';
          const spanCountry=document.createElement('span'); spanCountry.className='country'; spanCountry.textContent=city.country;
          const actions=document.createElement('span'); actions.className='actions';
          const btn=document.createElement('button'); btn.className='btn btn-copy'; btn.textContent='Copy link';
          btn.addEventListener('click', ev=>{ ev.stopPropagation(); navigator.clipboard.writeText(stadDeepLink(s.slug)).then(()=>toast('Stadium link copied')); });
          actions.appendChild(btn);
          line.append(spanSt, sep1, spanCity, sep2, spanCountry);
          el.append(line, actions);

          el.addEventListener('click',()=>{
            setQuery('stadium', s.slug); setQuery('city', null);
            const m=stadiumMarkersBySlug[s.slug]; revealMarker(m,'stadium'); syncLabels();
          });
          listStads.appendChild(el);
        });
        packIntoColumns(listStads);
      }

      renderCityList(CITIES);
      renderStadiumList(STADIUMS);

      /* SPA routes */
      function handleRoute(){
        const s=getQ('stadium'); const c=getQ('city');
        if(s && stadiumMarkersBySlug[s]){ setTab('stadiums'); revealMarker(stadiumMarkersBySlug[s],'stadium'); }
        else if(c && cityMarkersBySlug[c]){ setTab('cities'); revealMarker(cityMarkersBySlug[c],'city'); }
        else { setTab('cities'); fitAll(); }
        syncLabels();
      }
      window.addEventListener('popstate', handleRoute);

      /* search + filters */
      const searchEl=$("#search"), fUSA=$("#fUSA"), fCAN=$("#fCAN"), fMEX=$("#fMEX");
      const allowedCountry = c => (c==='USA'&&fUSA.checked)||(c==='Canada'&&fCAN.checked)||(c==='Mexico'&&fMEX.checked);

      function applyFilters(){
        const q=(searchEl.value||'').trim().toLowerCase();
        const cityMatches = CITIES.filter(c=> allowedCountry(c.country) && (c.name.toLowerCase().includes(q)));
        const stadiumMatches = STADIUMS.filter(s=>{
          const city=CITIES.find(c=>c.slug===s.citySlug)||{country:'', name:''};
          return allowedCountry(city.country) && (s.name.toLowerCase().includes(q) || city.name.toLowerCase().includes(q));
        });
        renderCityList(cityMatches);
        renderStadiumList(stadiumMatches);
        syncLabels();
      }
      [searchEl,fUSA,fCAN,fMEX].forEach(ctrl => (ctrl===searchEl ? ctrl.addEventListener('input',applyFilters) : ctrl.addEventListener('change',applyFilters)));

      /* stabilize & initial route */
      window.addEventListener('load',()=>{ map.invalidateSize(); syncLabels(); });
      activeTile && activeTile.on && activeTile.on('load',()=>{ map.invalidateSize(); syncLabels(); });
      requestAnimationFrame(()=>{ map.invalidateSize(); syncLabels(); });
      handleRoute();
    }

    /* ===== Load local vendors first, fallback to CDNs ===== */
    function loadClusterThenBoot(){
      if(!window.L){ showErr('Leaflet JS did not load'); return; }
      addScript('/assets/vendor/leaflet.markercluster/leaflet.markercluster.js',
        boot,
        ()=>addScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
          boot,
          ()=>addScript('https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js', boot,
            ()=>{ showErr('MarkerCluster JS could not be loaded. Falling back to no clustering.'); boot(); }
          )
        )
      );
    }
    addScript('<script>
  // Robust loader: CDN first (reliable), then verify, then cluster, then (optionally) local
  function robustLoad(srcList, done) {
    const next = () => {
      const src = srcList.shift();
      if (!src) return done(new Error('All sources failed'));
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = () => done(null, src);
      s.onerror = () => next();
      document.head.appendChild(s);
    };
    next();
  }

  // 1) Load Leaflet (prefer CDN)
  robustLoad([
    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
    'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
    '/assets/vendor/leaflet/leaflet.js' // local (optional) as last resort
  ], (err) => {
    if (err || !window.L) { console.error('Leaflet failed to load'); return; }

    // 2) Load MarkerCluster (prefer CDN)
    robustLoad([
      'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
      'https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
      '/assets/vendor/leaflet.markercluster/leaflet.markercluster.js' // local (optional)
    ], () => {
      // Even if cluster failed, boot anyway (we handle no-cluster gracefully)
      boot();
    });
  });
</script>',
      loadClusterThenBoot,
      ()=>addScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', loadClusterThenBoot,
        ()=>addScript('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js', loadClusterThenBoot,
          ()=>showErr('Leaflet JS could not be loaded from CDNs.')
        )
      )
    );
  </script>
</body>
</html>